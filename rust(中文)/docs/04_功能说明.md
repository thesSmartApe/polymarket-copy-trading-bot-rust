# 功能概述

本文档解释了 Polymarket 跟单交易机器人的功能和工作原理。

## 目录

1. [概述](#1-概述)
2. [核心功能](#2-核心功能)
3. [交易流程](#3-交易流程逐步说明)
4. [性能特征](#4-性能特征)
5. [限制](#5-限制)
6. [安全功能](#6-安全功能摘要)
7. [理解输出](#7-理解输出)
8. [下一步](#8-下一步)

## 1. 概述

### 1.1 这个机器人做什么

机器人监控区块链事件，检测特定"鲸鱼"（成功交易者）在 Polymarket 上进行的交易，并自动以缩小的仓位规模复制这些交易。

**关键策略要点：**
- **2% 仓位缩放：** 以鲸鱼规模的 2% 复制交易（可配置）
- **分层执行：** 根据交易规模使用不同策略（4000+、2000+、1000+、<1000）
- **风险保护：** 多层安全系统防止危险交易
- **智能定价：** 价格缓冲优化成交率，同时最小化滑点
- **自动重试：** 重新提交逻辑最大化成交率

完整策略详情，请参阅 [交易策略指南](05_交易策略.md)。

## 2. 核心功能

### 2.1 实时交易检测

- **WebSocket 连接：** 通过 WebSocket 连接到 Polygon 区块链以进行实时事件监控
- **事件过滤：** 仅处理来自目标鲸鱼地址的交易
- **区块链事件：** 监控来自 Polymarket 订单簿合约的 `OrdersFilled` 事件

**工作原理：**
1. 机器人订阅区块链日志
2. 过滤来自目标鲸鱼地址的交易
3. 解析交易详情（代币、规模、价格、方向）
4. 将交易排队处理

---

### 2.2 智能仓位大小

机器人不会以 1:1 的规模复制交易。相反，它使用缩放仓位：

- **默认缩放：** 鲸鱼仓位规模的 2%
- **最小规模：** 低于 $1.01 美元的订单被跳过（防止灰尘订单）
- **概率大小：** 非常小的仓位可能会概率执行或跳过

**示例：**
- 鲸鱼以 $0.50 买入 10,000 股 = $5,000
- 机器人以 $0.50 买入 200 股 = $100（$5,000 的 2%）

**为什么缩放：**
- 降低风险敞口
- 允许复制账户更大的鲸鱼
- 如果鲸鱼使用全部账户，防止仓位规模问题

---

### 2.3 分层执行策略

不同的交易规模获得不同的执行策略：

| 交易规模（股数） | 价格缓冲 | 规模倍数 | 策略 |
|---------------------|--------------|-----------------|----------|
| 4000+（大）       | +0.01        | 1.25x           | 激进 |
| 2000-3999（中）  | +0.01        | 1.0x            | 标准 |
| 1000-1999（小）   | +0.00        | 1.0x            | 保守 |
| <1000（非常小）  | +0.00        | 1.0x            | 保守 |

**价格缓冲：** 在鲸鱼价格之上支付的额外金额（提高成交率）  
**规模倍数：** 相对于鲸鱼的仓位规模（1.25x = 比正常缩放大 25%）

**大额交易（4000+ 股）：**
- 更激进（更高的缓冲，更大的规模）
- 如果订单失败，更多重新提交尝试
- 首次重试时价格追逐

**小额交易（<1000 股）：**
- 更保守（无缓冲）
- 更少的重新提交尝试
- 无价格追逐

---

### 2.4 订单类型

机器人根据交易特征使用不同的订单类型：

**FAK（立即成交或取消）：**
- 立即执行或取消
- 用于买单（大多数交易）
- 快速执行，不放在订单簿上

**GTD（指定日期前有效）：**
- 在订单簿上放置带过期时间的订单
- 用于：
  - 卖单（所有卖出）
  - 失败买单的最终重试尝试
- 过期时间：
  - 实时市场 61 秒
  - 非实时市场 1800 秒（30 分钟）

---

### 2.5 自动订单重新提交

如果订单未能完全成交：

**重试逻辑：**
- 最多 4-5 次尝试（取决于交易规模）
- 大额交易首次重试时价格升级
- 小额交易的指数退避延迟

**示例流程：**
1. 初始订单失败（FAK）
2. 重试 #1：相同价格或 +0.01（如果是大额交易）
3. 重试 #2-4：相同价格（平重试）
4. 最终尝试：GTD 订单（保留在订单簿上）

**为什么这有帮助：**
- 市场条件变化很快
- 提高波动市场的成交率
- 平衡速度与执行质量

---

### 2.6 风险管理（熔断器保护）

保护您免受在危险条件下复制交易：

**触发条件：**
- 短时间内多次大额交易
- 低订单簿深度（流动性稀薄）
- 快速连续交易模式

**操作：**
- 在指定持续时间内阻止交易（默认：2 分钟）
- 在允许交易之前检查订单簿深度
- 防止在潜在操纵期间复制

**配置：**
- `CB_LARGE_TRADE_SHARES`：触发的最小规模（默认：1500）
- `CB_CONSECUTIVE_TRIGGER`：触发的交易数量（默认：2）
- `CB_SEQUENCE_WINDOW_SECS`：时间窗口（默认：30 秒）
- `CB_MIN_DEPTH_USD`：所需的最小流动性（默认：$200）
- `CB_TRIP_DURATION_SECS`：阻止持续时间（默认：120 秒）

---

### 2.7 市场缓存系统

**目的：** 无需 API 延迟的快速查找

**缓存数据：**
- 市场信息（代币 ID、slug）
- 实时/非实时状态
- 特定运动市场数据（ATP、法甲）

**刷新：** 在后台自动更新（定期刷新）

**好处：**
- 更快执行（无 API 等待时间）
- 减少 API 速率限制
- 更可靠（较少依赖外部 API）

---

### 2.8 特定运动优化

**ATP 市场：**
- 额外的 +0.01 价格缓冲
- 针对网球市场特征优化

**法甲市场：**
- 额外的 +0.01 价格缓冲
- 针对足球市场特征优化

**其他市场：**
- 标准执行策略
- 无额外缓冲

**自动检测：** 机器人自动检测市场类型并应用适当的策略。

---

### 2.9 全面日志记录

**控制台输出：**
- 实时交易信息
- 颜色编码的状态消息
- 成交百分比
- 市场条件

**CSV 日志记录：**
- 文件：`matches_optimized.csv`
- 所有交易都记录时间戳
- 包括：区块号、代币 ID、美元价值、股数、价格、方向、状态、订单簿数据、交易哈希、实时状态

**用例：**
- 性能分析
- 调试
- 审计跟踪
- 交易后分析

---

### 2.10 实时市场检测

**自动检测：**
- 检查市场是否"实时"（事件当前正在发生）
- 实时与非实时市场的不同过期时间
- 实时市场的更快执行

**影响：**
- 实时市场：61 秒 GTD 过期（更快）
- 非实时：30 分钟 GTD 过期（更有耐心）

---

## 3. 交易流程（逐步说明）

这是简化概述。完整的详细逻辑，请参阅 [策略指南](05_交易策略.md)。

1. **检测：** 鲸鱼在 Polymarket 上进行交易
2. **接收事件：** 机器人通过 WebSocket 接收区块链事件（<1 秒延迟）
3. **解析：** 机器人提取交易详情（代币、规模、价格、方向）
4. **过滤：**
   - 检查交易是否来自目标鲸鱼（如果不是则跳过）
   - 检查交易规模是否足够大（如果太小则跳过，<10 股）
5. **风险保护检查：** 多层安全系统检查：
   - 第 1 层：快速检查（交易规模、序列检测）
   - 第 2 层：订单簿深度分析（如果触发）
   - 第 3 层：触发状态检查
   - 结果：如果检测到危险条件，则阻止交易
6. **仓位大小：** 计算您的订单规模：
   - 基础：鲸鱼规模的 2%
   - 应用层级倍数（4000+ 为 1.25x，否则为 1.0x）
   - 检查最小规模（$1.01 要求）
   - 非常小仓位的概率执行
7. **价格计算：** 确定限价：
   - 从层级获取基础缓冲（大额为 0.01，小额为 0.00）
   - 添加特定运动缓冲（网球/足球：+0.01）
   - 计算：whale_price + total_buffer
   - 限制在有效范围内（0.01-0.99）
8. **订单类型选择：**
   - 卖单：始终 GTD
   - 买单：初始为 FAK，最终重试时为 GTD
9. **订单创建：** 使用计算的参数创建签名订单
10. **提交：** 向 Polymarket API 提交订单
11. **结果处理：**
    - 成功：检查成交金额，如果部分成交则重新提交
    - 失败：进入重新提交循环（4-5 次尝试）
    - 最终尝试：如果仍未成交，切换到 GTD 订单
12. **日志记录：** 将所有详情记录到 CSV 和控制台，带有颜色编码的状态

---

## 4. 性能特征

**延迟：**
- 事件检测：<1 秒（取决于区块链）
- 订单处理：<100ms
- 从鲸鱼交易到订单的总时间：<2 秒

**吞吐量：**
- 处理多个并发交易
- 高频场景的排队处理
- 自动背压处理

**可靠性：**
- WebSocket 失败时自动重连
- 失败订单的重试逻辑
- 熔断器防止不良交易
- 全面的错误处理

---

## 5. 限制

**机器人不做什么：**
- ❌ 市场分析或预测
- ❌ 止损或止盈订单
- ❌ 投资组合管理
- ❌ 成交后的仓位监控
- ❌ 退出策略（您管理平仓）
- ❌ 多鲸鱼复制（一次一个鲸鱼）

**您需要手动做什么：**
- 监控您的仓位
- 适当时平仓
- 管理您的投资组合
- 调整风险参数
- 找到好的鲸鱼来复制

---

## 6. 安全功能摘要

✅ 缩放仓位大小（默认 2%）  
✅ 危险条件的熔断器  
✅ 最小交易规模过滤器  
✅ 订单簿深度检查  
✅ 有限制的自动重试  
✅ 全面的错误处理  
✅ 用于测试的模拟交易模式  
✅ 用于审计的广泛日志记录  

---

## 7. 理解输出

**控制台消息：**

```
⚡ [B:12345] BUY_FILL | $100 | 200 OK | ...
```

- `[B:12345]`：区块号
- `BUY_FILL`：交易方向和类型
- `$100`：鲸鱼交易的美元价值
- `200 OK`：HTTP 状态（200 = 成功）
- 后面的数字：您的成交详情、价格、规模

**颜色编码：**
- 🟢 绿色：成功成交（高百分比）
- 🟡 黄色：部分成交（中等百分比）
- 🔴 红色：失败或低成交（低百分比）
- 🔵 蓝色：实时市场指示器

**CSV 格式：**
所有交易都记录：timestamp, block, token_id, usd_value, shares, price, direction, status, order_book_data, tx_hash, is_live

---

## 8. 下一步

- 阅读 [配置指南](03_配置指南.md) 以调整设置
- 查看 [交易策略指南](05_交易策略.md) 了解详细策略逻辑
- 如果您还没有设置，请查看 [设置指南](02_设置指南.md)
- 如果您遇到问题，请查看 [故障排除](06_故障排除.md)
